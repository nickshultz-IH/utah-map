
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Southwest Utah Map — Google Maps API + Google Sheet</title>
  <meta name="description" content="Atlist-style map rebuilt using Google Maps JavaScript API, Google Sheets, and MarkerClusterer." />
  <style>
    :root { --sidebar-w: 380px; --accent: #0f766e; }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .app { height: 100vh; display: grid; grid-template-columns: var(--sidebar-w) 1fr; }
    .sidebar { height: 100%; overflow: hidden; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; background: #fff; }
    .sidebar header { padding: 16px 16px 8px; border-bottom: 1px solid #e5e7eb; }
    .sidebar h1 { margin: 0 0 6px; font-size: 18px; }
    .controls { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; gap: 8px; display: grid; grid-template-columns: 1fr; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .search { display: flex; }
    .search input { flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
    .btn { appearance: none; border: 1px solid #d1d5db; background: #fff; border-radius: 8px; padding: 8px 10px; font-size: 13px; cursor: pointer; }
    .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .filters { padding: 8px 16px; overflow: auto; border-bottom: 1px solid #e5e7eb; max-height: 35%; }
    .filters h3 { margin: 10px 0 8px; font-size: 13px; color: #374151; text-transform: uppercase; letter-spacing: .04em; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 999px; font-size: 12px; cursor: pointer; user-select: none; }
    .chip input { pointer-events: none; }
    .list { overflow: auto; flex: 1; }
    .card { border-bottom: 1px solid #f3f4f6; padding: 12px 16px; cursor: pointer; }
    .card:hover { background: #f9fafb; }
    .card h4 { margin: 0 0 6px; font-size: 15px; }
    .meta { color: #6b7280; font-size: 12px; }
    #map { height: 100%; width: 100%; }
    @media (max-width: 768px) {
      .app { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      .sidebar { grid-row: 1 / 2; border-right: 0; border-bottom: 1px solid #e5e7eb; }
      #map { grid-row: 2 / 3; height: 600px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <header>
        <h1>Welcome to Southwest Utah</h1>
        <div class="meta" id="summary">Loading places…</div>
      </header>

      <div class="controls">
        <div class="search">
          <input id="search" type="search" placeholder="Search by name, tags or notes" />
        </div>
        <div class="row">
          <button id="btn-nearme" class="btn" title="Sort list by distance">Use my location</button>
          <select id="sort" class="btn" aria-label="Sort">
            <option value="name">Sort: name (A→Z)</option>
            <option value="distance">Sort: nearest</option>
          </select>
          <button id="btn-reset" class="btn" title="Clear all filters">Reset</button>
        </div>
      </div>

      <div class="filters">
        <h3>Groups</h3>
        <div id="group-filters" class="chips"></div>
        <h3 style="margin-top:14px">Tags</h3>
        <div id="tag-filters" class="chips"></div>
      </div>

      <div id="list" class="list"></div>
    </aside>

    <div id="map" role="application" aria-label="Map"></div>
  </div>

  <script>
    const CONFIG = {
      GOOGLE_MAPS_API_KEY: "AIzaSyAYvECoY90cl8YQwhKiBwEBKqW_zrK1AQY",
      SHEET: {
        id: "1cd3VUWQKs3zB68Ji-JXVjJkqyXi87KOoSErjypixD4I",
        range: "Sheet1",
      },
      MAP: {
        center: { lat: 37.0953, lng: -113.5786 },
        zoom: 9,
        minZoom: 3,
        styles: [], // you can paste your SnazzyMaps JSON here
      },
      UI: {
        cluster: true,
        listShowsDistance: true,
      }
    };

    let map, infoWindow, allPlaces = [], markers = [], clusterer = null;
    let userPos = null;

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function haversine(a, b) {
      const R = 6371e3;
      const toRad = (d) => d * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
      const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2 * R * Math.asin(Math.sqrt(s));
    }

    function escapeHtml(str="") {
      return str.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#039;'}[c]));
    }

    function uniq(arr) { return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b)); }
    function parseTags(val) { return val ? val.split(",").map(s=>s.trim()).filter(Boolean) : []; }

    function markerHtml(place) {
      const safeName = escapeHtml(place.name);
      const addr = place.address ? `<div class="meta">${escapeHtml(place.address)}</div>` : "";
      const notes = place.useHtml ? (place.notes || "") : escapeHtml(place.notes || "");
      const headerImg = place.headerImage ? `<div style="margin-bottom:8px"><img src="${place.headerImage}" alt="${safeName}" style="max-width:100%;border-radius:6px"/></div>` : "";
      return `
        <div style="max-width:320px">
          ${headerImg}
          <h3>${safeName}</h3>
          ${addr}
          <div>${notes}</div>
        </div>`;
    }

    async function fetchSheetRows() {
      const key = CONFIG.GOOGLE_MAPS_API_KEY;
      const id = CONFIG.SHEET.id;
      const range = encodeURIComponent(CONFIG.SHEET.range);
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${range}?key=${key}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Sheets API error ${res.status}`);
      const json = await res.json();
      const rows = json.values || [];
      const headers = rows[0].map(h => (h || '').trim());
      return rows.slice(1).map(r => Object.fromEntries(headers.map((h,i) => [h, r[i] || ""])));
    }

    function normalizeRow(row) {
      return {
        name: row["Name"] || "Untitled",
        address: row["Address"] || "",
        lat: parseFloat(row["Latitude"]) || null,
        lng: parseFloat(row["Longitude"]) || null,
        notes: row["Notes"] || "",
        group: row["Group"] || "",
        useHtml: (row["Use HTML"] || "").toLowerCase() === 'true',
        headerImage: row["Header Image URL"] || ""
      };
    }

    function refreshClusters() {
      if (!CONFIG.UI.cluster) return;
      if (!window.markerClusterer || !window.markerClusterer.MarkerClusterer) return;
      if (clusterer) clusterer.clearMarkers();
      const visible = markers.filter(m => m.getMap());
      if (visible.length) {
        clusterer = new window.markerClusterer.MarkerClusterer({ map, markers: visible });
      }
    }

    async function initApp() {
      try {
        const rows = await fetchSheetRows();
        allPlaces = rows.map(normalizeRow).filter(p => p.lat && p.lng);

        map = new google.maps.Map(document.getElementById('map'), {
          center: CONFIG.MAP.center,
          zoom: CONFIG.MAP.zoom,
          styles: CONFIG.MAP.styles,
        });
        infoWindow = new google.maps.InfoWindow();

        markers = allPlaces.map((p) => {
          const marker = new google.maps.Marker({
            position: { lat: p.lat, lng: p.lng },
            map,
            title: p.name
          });
          marker.__data = p;
          marker.addListener('click', () => {
            infoWindow.setContent(markerHtml(p));
            infoWindow.open({ anchor: marker, map });
          });
          return marker;
        });

        refreshClusters();
      } catch (err) {
        alert('Failed to initialize: ' + err.message);
      }
    }

    (function loadClusterer() {
      const s = document.createElement('script');
      s.src = "https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js";
      s.defer = true;
      s.addEventListener('load', () => { if (markers.length) refreshClusters(); });
      document.head.appendChild(s);
    })();

    window.__initMap = () => initApp();
  </script>

  <script async src="https://maps.googleapis.com/maps/api/js?key=YOUR_MAPS_API_KEY&callback=__initMap"></script>
</body>
</html>
