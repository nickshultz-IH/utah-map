<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Southwest Utah Map — Intermountain Health</title>
  <meta name="description" content="Atlist-style map with Google Maps JS, Google Sheets, MarkerClusterer, and Intermountain styling." />
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --sidebar-w: 380px;
      --accent: #4A00E2;   /* cluster/accents */
      --dark: #110057;     /* dark brand blue */
      --muted: #6b7280;
      --chip: #F7F5F9;
    }
    html, body { height: 100%; margin: 0; color: var(--dark); font-family: 'Source Sans 3', Arial, sans-serif; }
    h1, h2, h3, h4, .btn, .chip { font-family: 'Inter', Arial, sans-serif; }
    .app { height: 100vh; display: grid; grid-template-columns: var(--sidebar-w) 1fr; }
    .sidebar { height: 100%; overflow: hidden; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; background: #fff; }
    .sidebar header { padding: 16px 16px 8px; border-bottom: 1px solid #e5e7eb; }
    .sidebar h1 { margin: 0 0 6px; font-size: 20px; font-weight: 700; }
    .controls { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; gap: 8px; display: grid; grid-template-columns: 1fr; background: #fff; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .search input { width:100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; }
    .btn { appearance: none; border: 1px solid #d1d5db; background: #fff; border-radius: 10px; padding: 8px 10px; font-size: 13px; cursor: pointer; }
    .filters { padding: 10px 16px; overflow: auto; border-bottom: 1px solid #e5e7eb; max-height: 30%; background: #fff; }
    .filters h3 { margin: 10px 0 8px; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--chip); border: 1px solid #e5e7eb; border-radius: 999px; font-size: 12px; cursor: pointer; user-select: none; }
    .list { overflow: auto; flex: 1; background: #fff; }
    .group-head { padding: 10px 16px; font-size: 13px; color:#374151; font-weight:600; text-transform: uppercase; letter-spacing: .04em; background:#fafafa; border-top:1px solid #eee; border-bottom:1px solid #f0f0f0; position: sticky; top: 0; z-index: 1; }
    .card { border-bottom: 1px solid #f3f4f6; padding: 12px 16px; cursor: pointer; display:flex; align-items:center; gap:10px; }
    .card:hover { background: #f9fafb; }
    .card h4 { margin: 0 0 2px; font-size: 15px; }
    .meta { color: var(--muted); font-size: 12px; }
    .pin-img { width: 20px; height: 20px; flex:0 0 20px; object-fit: contain; }
    #map { height: 100%; width: 100%; }
    /* InfoWindow content */
    .iw { max-width: 340px; font-family: 'Source Sans 3', Arial, sans-serif; }
    .iw .hero { position: relative; overflow: hidden; border-radius: 8px; }
    .iw .hero img { display:block; width:100%; height:auto; }
    .iw .tagpill { position:absolute; top:10px; left:10px; background:#ffffff; color:#111827; font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid #e5e7eb; }
    .iw h3 { margin:10px 0 4px; font-size:18px; font-weight:700; }
    .iw .group { color:#374151; font-size:13px; margin-bottom:8px; }
    .iw .addr { color:#6b7280; font-size:12px; margin-bottom:8px; }
    .iw .btn-learn { display:block; width:100%; max-width:100%; box-sizing:border-box; text-align:center; padding:12px 14px; background:#110057; color:#fff; border-radius:10px; text-decoration:none; font-family:'Inter', Arial, sans-serif; font-weight:600; margin-top:10px; overflow:hidden; text-overflow:ellipsis; }
    .iw .body { display:none; }
    @media (max-width: 768px) {
      .app { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      .sidebar { grid-row: 1 / 2; border-right: 0; border-bottom: 1px solid #e5e7eb; }
      #map { grid-row: 2 / 3; height: 600px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <header>
        <h1>Welcome to Southwest Utah</h1>
        <p>Version 2</p>
        <div class="meta" id="summary">Loading places…</div>
      </header>
      <div class="controls">
        <div class="search">
          <input id="search" type="search" placeholder="Search by name, market or keywords" />
        </div>
        <div class="row">
          <button id="btn-nearme" class="btn" title="Sort list by distance">Use my location</button>
          <select id="sort" class="btn" aria-label="Sort">
            <option value="name">Sort: name (A→Z)</option>
            <option value="distance">Sort: nearest</option>
          </select>
          <button id="btn-reset" class="btn" title="Clear keywords & tag filters">Reset</button>
        </div>
      </div>
      <div class="filters">
        <h3>Markets</h3>
        <div id="tag-filters" class="chips"></div>
      </div>
      <div id="list" class="list"></div>
    </aside>
    <div id="map" role="application" aria-label="Map"></div>
  </div>

  <script>
    /* =========================
       Config
       ========================= */
    var CONFIG = {
      GOOGLE_MAPS_API_KEY: "AIzaSyAYvECoY90cl8YQwhKiBwEBKqW_zrK1AQY",
      SHEET: { id: "1cd3VUWQKs3zB68Ji-JXVjJkqyXi87KOoSErjypixD4I", range: "Sheet1!A:Z" },
      MAP: {
        center: { lat: 37.0953, lng: -113.5786 },
        zoom: 9,
        minZoom: 3,
        styles: [
          { "featureType": "administrative", "elementType": "all", "stylers": [ { "saturation": "-100" } ] },
          { "featureType": "administrative.province", "elementType": "all", "stylers": [ { "visibility": "off" } ] },
          { "featureType": "landscape", "elementType": "all", "stylers": [ { "saturation": -100 }, { "lightness": 65 }, { "visibility": "on" } ] },
          { "featureType": "poi", "elementType": "all", "stylers": [ { "saturation": -100 }, { "lightness": "50" }, { "visibility": "simplified" } ] },
          { "featureType": "road", "elementType": "all", "stylers": [ { "saturation": "-100" } ] },
          { "featureType": "road.highway", "elementType": "all", "stylers": [ { "visibility": "simplified" } ] },
          { "featureType": "road.arterial", "elementType": "all", "stylers": [ { "lightness": "30" } ] },
          { "featureType": "road.local", "elementType": "all", "stylers": [ { "lightness": "40" } ] },
          { "featureType": "transit", "elementType": "all", "stylers": [ { "saturation": -100 }, { "visibility": "simplified" } ] },
          { "featureType": "water", "elementType": "geometry", "stylers": [ { "hue": "#ffff00" }, { "lightness": -25 }, { "saturation": -97 } ] },
          { "featureType": "water", "elementType": "labels", "stylers": [ { "lightness": -25 }, { "saturation": -100 } ] }
        ]
      },
      UI: { cluster: true },
      ASSETS_BASE: "https://nickshultz-ih.github.io/utah-map/",
      ICON_TOKENS: {
        cobalt:"map-marker-cobalt.png",
        coral:"map-marker-coral.png",
        darkblue:"map-marker-darkblue.png",
        dark:"map-marker-darkblue.png",
        softblue:"map-marker-softblue.png",
        soft:"map-marker-softblue.png"
      },
      ICONS_BY_GROUP: {
        "Cobalt":"map-marker-cobalt.png",
        "Coral":"map-marker-coral.png",
        "Dark Blue":"map-marker-darkblue.png",
        "Soft Blue":"map-marker-softblue.png"
      }
    };

    var map, infoWindow, allPlaces = [], markers = [], clusterer = null;
    var userPos = null;

    function $(sel){ return document.querySelector(sel); }
    function $$(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }

    /* =========================
       Utils
       ========================= */
    function haversine(a, b) {
      var R = 6371e3;
      function toRad(d){ return d * Math.PI / 180; }
      var dLat = toRad(b.lat - a.lat);
      var dLng = toRad(b.lng - a.lng);
      var lat1 = toRad(a.lat), lat2 = toRad(b.lat);
      var s = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)*Math.sin(dLng/2);
      return 2 * R * Math.asin(Math.sqrt(s));
    }
    function escapeHtml(str) {
      str = str || "";
      return str.replace(/[&<>"']/g, function(c){ return ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" })[c]; });
    }
    function uniq(arr){ return Array.from(new Set((arr||[]).filter(Boolean))).sort(function(a,b){ return a.localeCompare(b); }); }
    function parseList(val){ return val ? val.split(",").map(function(s){ return s.trim(); }).filter(Boolean) : []; }

    /* =========================
       Icons
       ========================= */
    function normalizeIconValue(v){
      if (!v) return "";
      var raw = String(v).trim();
      if (/^https?:\/\//i.test(raw)) return raw;                 // Full URL
      if (/\.(png|jpe?g|svg|webp)$/i.test(raw))                  // Filename in repo
        return CONFIG.ASSETS_BASE + raw.replace(/^\/+/, "");
      var token = raw.toLowerCase().replace(/[^a-z]/g, "");      // letters only
      var filename = CONFIG.ICON_TOKENS[token];
      return filename ? CONFIG.ASSETS_BASE + filename : "";
    }
    function resolveIconSrc(place){
      var fromCell = normalizeIconValue(place.iconUrl);
      if (fromCell) return fromCell;
      var groupFile = CONFIG.ICONS_BY_GROUP[place.group];
      if (groupFile) return CONFIG.ASSETS_BASE + groupFile;
      return "";
    }
    function buildIcon(place){
      var src = resolveIconSrc(place);
      return src ? { url: src, scaledSize: new google.maps.Size(36,36) } : undefined;
    }

    /* =========================
       Bubble (InfoWindow)
       ========================= */
    function markerHtml(place){
      var safeName = escapeHtml(place.name);
      var addr = place.address ? '<div class="addr">' + escapeHtml(place.address) + '</div>' : '';
      var group = place.group ? '<div class="group">' + escapeHtml(place.group) + '</div>' : '';
      var tag = (place.tags && place.tags[0]) ? '<div class="tagpill">' + escapeHtml(place.tags[0]) + '</div>' : '';
      var headerImg = place.headerImage ? '<div class="hero"><img src="' + place.headerImage + '" alt="' + safeName + '"/>' + tag + '</div>' : '';
      var learnHref = place.moreUrl || ('https://www.google.com/search?q=' + encodeURIComponent((place.name||'') + ' ' + (place.address||'')));
      return [
        '<div class="iw">',
          headerImg,
          '<h3>' + safeName + '</h3>',
          group,
          addr,
          '<a class="btn-learn" href="' + learnHref + '" target="_blank" rel="noopener">Learn More</a>',
        '</div>'
      ].join('');
    }
    function ensureInfoWindow(){
      if (!infoWindow) infoWindow = new google.maps.InfoWindow({ maxWidth: 360 });
    }
    function openInfoForMarker(marker){
      ensureInfoWindow();
      infoWindow.close();
      var p = marker.__data;
      infoWindow.setContent(markerHtml(p));
      // Anchor to the marker for reliable opening
      infoWindow.open({ anchor: marker, map: map, shouldFocus: false });
    }
    function zoomAndOpen(marker){
      var pos = marker.getPosition();
      var targetZoom = Math.max(map.getZoom(), 17);
      map.panTo(pos);
      if (map.getZoom() < targetZoom) map.setZoom(targetZoom);
      // Wait for clusters/markers to re-render, then open
      google.maps.event.addListenerOnce(map, 'idle', function(){
        requestAnimationFrame(function(){ openInfoForMarker(marker); });
      });
    }

    /* =========================
       Data
       ========================= */
    function fetchSheetRows(){
      var url = 'https://sheets.googleapis.com/v4/spreadsheets/' + CONFIG.SHEET.id + '/values/' + encodeURIComponent(CONFIG.SHEET.range) + '?key=' + CONFIG.GOOGLE_MAPS_API_KEY;
      return fetch(url).then(function(res){
        if (!res.ok) throw new Error('Sheets API error ' + res.status);
        return res.json();
      }).then(function(json){
        var rows = json.values || [];
        if (!rows.length) return [];
        var headers = rows[0].map(function(h){ return (h||'').trim(); });
        return rows.slice(1).map(function(r){
          var o = {};
          for (var i=0;i<headers.length;i++){ o[headers[i]] = r[i] || ""; }
          return o;
        });
      });
    }
    function normalizeRow(row){
      var keywords = parseList(row["Keywords"] || row["Notes"] || "");
      return {
        name: row["Name"] || "Untitled",
        address: row["Address"] || "",
        lat: parseFloat(row["Latitude"]) || null,
        lng: parseFloat(row["Longitude"]) || null,
        group: row["Group"] || "",
        tags: parseList(row["Tags"] || ""),
        iconUrl: row["Icon URL"] || "",
        headerImage: row["Header Image URL"] || "",
        moreUrl: row["Learn More URL"] || row["URL"] || "",
        useHtml: String(row["Use HTML"] || "").toLowerCase() === 'true',
        keywordsText: keywords.join(", ")
      };
    }

    /* =========================
       List + Filters
       ========================= */
    function groupBy(arr, keyFn){
      var map = new Map();
      for (var i=0;i<arr.length;i++){
        var it = arr[i];
        var k = keyFn(it) || "Other";
        if (!map.has(k)) map.set(k, []);
        map.get(k).push(it);
      }
      return map;
    }
    function renderList(places){
      var list = document.getElementById("list");
      list.innerHTML = "";
      var grouped = groupBy(places, function(p){ return p.group; });
      var groupsSorted = Array.from(grouped.keys()).sort(function(a,b){ return a.localeCompare(b); });
      for (var gi=0; gi<groupsSorted.length; gi++){
        var g = groupsSorted[gi];
        var head = document.createElement("div");
        head.className = "group-head";
        head.textContent = g || "Other";
        list.appendChild(head);
        var arr = grouped.get(g);
        for (var j=0; j<arr.length; j++){
          var p = arr[j];
          var item = document.createElement("div"); item.className = "card";
          var iconSrc = resolveIconSrc(p);
          var iconEl = iconSrc ? '<img class="pin-img" src="' + iconSrc + '" alt=""/>' : '';
          item.innerHTML = iconEl + '<div><h4>' + escapeHtml(p.name) + '</h4><div class="meta">' + (p.tags||[]).join(' · ') + '</div></div>';
          (function(pl){
            item.addEventListener("click", function(){
              var m = markers.find(function(mk){ return mk.__data === pl; });
              if (m) zoomAndOpen(m);
            });
          })(p);
          list.appendChild(item);
        }
      }
      document.getElementById("summary").textContent = places.length + ' place' + (places.length===1?'':'s') + ' shown';
    }
    function buildFiltersUI(){
      var tags = uniq([].concat.apply([], allPlaces.map(function(p){ return p.tags||[]; })));
      var tagWrap = document.getElementById("tag-filters");
      tagWrap.innerHTML = tags.map(function(t){
        return '<label class="chip"><input type="checkbox" value="' + escapeHtml(t) + '" checked /> ' + escapeHtml(t) + '</label>';
      }).join('');
      tagWrap.addEventListener('change', applyFilters);
    }

    /* =========================
       Clusters + Filtering
       ========================= */
    function updateClustererWithVisible(){
      if (!clusterer) return;
      var visible = markers.filter(function(m){ return !!m.getMap(); });
      clusterer.clearMarkers();
      if (visible.length) clusterer.addMarkers(visible);
    }
    function applyFilters(){
      var q = (document.getElementById("search").value || "").trim().toLowerCase();
      var activeTags = new Set([].slice.call(document.querySelectorAll('#tag-filters input:checked')).map(function(i){ return i.value; }));

      var matches = [];
      for (var i=0; i<allPlaces.length; i++){
        var place = allPlaces[i];
        var ok = true;

        // If nothing checked => show nothing
        if (activeTags.size === 0) {
          ok = false;
        } else {
          var placeTags = place.tags || [];
          var anyMatch = placeTags.some(function(t){ return activeTags.has(t); });
          if (!anyMatch) ok = false;
        }

        if (ok && q){
          var hay = (place.name + " " + place.group + " " + (place.tags||[]).join(" ") + " " + (place.keywordsText||"")).toLowerCase();
          if (hay.indexOf(q) === -1) ok = false;
        }

        var marker = markers[i];
        marker.setMap(ok ? map : null);
        if (ok) matches.push(place);
      }

      if (userPos && document.getElementById("sort").value === 'distance'){
        for (var k=0; k<matches.length; k++){
          var p = matches[k];
          p._distanceM = haversine(userPos, {lat: p.lat, lng: p.lng});
        }
        matches.sort(function(a,b){ return a._distanceM - b._distanceM; });
      } else {
        matches.sort(function(a,b){ return a.name.localeCompare(b.name); });
      }

      renderList(matches);
      updateClustererWithVisible();
    }

    /* =========================
       Init
       ========================= */
    function initApp(){
      fetchSheetRows().then(function(rows){
        allPlaces = rows.map(normalizeRow).filter(function(p){ return p.lat && p.lng; });

        map = new google.maps.Map(document.getElementById('map'), {
          center: CONFIG.MAP.center,
          zoom: CONFIG.MAP.zoom,
          minZoom: CONFIG.MAP.minZoom,
          styles: CONFIG.MAP.styles,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: true
        });
        infoWindow = new google.maps.InfoWindow({ maxWidth: 360 });

        markers = allPlaces.map(function(p){
          var marker = new google.maps.Marker({
            position: { lat: p.lat, lng: p.lng },
            map: map,
            title: p.name,
            icon: buildIcon(p)
          });
          marker.__data = p;
          // Ensure marker click always opens the anchored InfoWindow
          marker.addListener('click', function(){ openInfoForMarker(marker); });
          return marker;
        });

        // Initialize clusterer ONCE with all markers (trimmed by filter)
        if (CONFIG.UI.cluster && window.markerClusterer && window.markerClusterer.MarkerClusterer){
          clusterer = new window.markerClusterer.MarkerClusterer({
            map: map,
            markers: markers,
            renderer: {
              render: function(o){
                var count = o.count, position = o.position;
                var svg = window.btoa(
                  "<svg xmlns='http://www.w3.org/2000/svg' width='44' height='44'>" +
                  "  <circle cx='22' cy='22' r='20' fill='#4A00E2' />" +
                  "  <text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' font-size='14' font-family='Inter, Arial' fill='white'>" + count + "</text>" +
                  "</svg>"
                );
                return new google.maps.Marker({
                  position: position,
                  icon: { url: 'data:image/svg+xml;base64,' + svg, scaledSize: new google.maps.Size(44,44) },
                  zIndex: Number(google.maps.Marker.MAX_ZINDEX) + count
                });
              }
            }
          });
          clusterer.addListener('clusterclick', function(e){
            map.panTo(e.latLng);
            map.setZoom(map.getZoom() + 2);
          });
        }

        // Fit bounds on first load
        if (markers.length){
          var bounds = new google.maps.LatLngBounds();
          markers.forEach(function(m){ bounds.extend(m.getPosition()); });
          map.fitBounds(bounds);
        }

        buildFiltersUI();
        document.getElementById('search').addEventListener('input', applyFilters);
        document.getElementById('sort').addEventListener('change', applyFilters);
        document.getElementById('btn-reset').addEventListener('click', function(){
          [].forEach.call(document.querySelectorAll('#tag-filters input[type=checkbox]'), function(i){ i.checked = true; });
          document.getElementById('search').value = '';
          document.getElementById('sort').value = 'name';
          applyFilters();
        });
        document.getElementById('btn-nearme').addEventListener('click', function(){
          getUserLocation().then(function(pos){
            userPos = pos;
            new google.maps.Marker({ position: pos, map: map, title: 'You are here', icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#4A00E2', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2 } });
            map.panTo(pos);
            document.getElementById('sort').value = 'distance';
            applyFilters();
          }).catch(function(){
            alert('Location permission was denied or unavailable.');
          });
        });

        applyFilters();
      }).catch(function(err){
        console.error(err);
        alert('Failed to initialize: ' + err.message);
      });
    }

    function getUserLocation(){
      return new Promise(function(resolve, reject){
        if (!navigator.geolocation) return reject(new Error('No geolocation'));
        navigator.geolocation.getCurrentPosition(
          function(pos){ resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }); },
          function(err){ reject(err); },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      });
    }

    // Load clusterer
    (function(){
      var s = document.createElement('script');
      s.src = "https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js";
      s.defer = true;
      s.addEventListener('load', function(){ /* clusterer created in initApp */ });
      document.head.appendChild(s);
    })();

    // Expose init for Maps callback
    window.__initMap = function(){ initApp(); };
  </script>

  <!-- Google Maps API (defer + async callback) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAYvECoY90cl8YQwhKiBwEBKqW_zrK1AQY&callback=__initMap&loading=async" defer></script>
</body>
</html>
