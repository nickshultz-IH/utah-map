<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Southwest Utah Map â€” Intermountain Health</title>
  <meta name="description" content="Custom Atlist-style map rebuilt with Google Maps JS, Google Sheets, MarkerClusterer, and brand styling." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Source Sans 3', Arial, sans-serif; margin:0; }
    h1,h2,h3,h4,.btn,.chip { font-family: 'Inter', Arial, sans-serif; }
    #map { height:100vh; width:100%; }
    .sidebar{width:380px;overflow:auto;float:left;height:100vh;border-right:1px solid #eee}
    .card{padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;align-items:center;gap:6px}
    .pin-img{width:20px;height:20px;object-fit:contain}
  </style>
</head>
<body>
<div class="sidebar"><div id="list"></div></div>
<div id="map"></div>
<script>
   const CONFIG = {
      GOOGLE_MAPS_API_KEY: "AIzaSyAYvECoY90cl8YQwhKiBwEBKqW_zrK1AQY",
      SHEET: {
        id: "1cd3VUWQKs3zB68Ji-JXVjJkqyXi87KOoSErjypixD4I",
        range: "Sheet1!A:Z",
      },
  MAP: { center: { lat: 37.0953, lng: -113.5786 }, zoom: 9 },
  ASSETS_BASE: "https://nickshultz-ih.github.io/utah-map/",
  ICON_TOKENS: {
    "cobalt":"map-marker-cobalt.png",
    "coral":"map-marker-coral.png",
    "darkblue":"map-marker-darkblue.png",
    "dark":"map-marker-darkblue.png",
    "softblue":"map-marker-softblue.png",
    "soft":"map-marker-softblue.png"
  },
  ICONS_BY_GROUP: {
    "Cobalt":"map-marker-cobalt.png",
    "Coral":"map-marker-coral.png",
    "Dark Blue":"map-marker-darkblue.png",
    "Soft Blue":"map-marker-softblue.png"
  }
};
let map, infoWindow, allPlaces=[], markers=[];
function normalizeIconValue(v){
  if(!v) return "";
  const raw=String(v).trim();
  if(/^https?:\/\//i.test(raw)) return raw;
  if(/\.(png|jpe?g|svg|webp)$/i.test(raw)) return CONFIG.ASSETS_BASE+raw.replace(/^\/+/,"");
  const token=raw.toLowerCase().replace(/[_\-\s]+/g,"").replace(/[^a-z]/g,"");
  const filename=CONFIG.ICON_TOKENS[token];
  return filename?CONFIG.ASSETS_BASE+filename:"";
}
function resolveIconSrc(place){
  const fromCell=normalizeIconValue(place.iconUrl);
  if(fromCell) return fromCell;
  const groupFile=CONFIG.ICONS_BY_GROUP[place.group];
  if(groupFile) return CONFIG.ASSETS_BASE+groupFile;
  return "";
}
function buildIcon(place){
  const src=resolveIconSrc(place);
  return src?{url:src,scaledSize:new google.maps.Size(32,32)}:undefined;
}
function markerHtml(place){
  return `<div><h3>${place.name}</h3><div>${place.address||""}</div></div>`;
}
async function fetchSheetRows(){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET.id}/values/${CONFIG.SHEET.range}?key=${CONFIG.GOOGLE_MAPS_API_KEY}`;
  const res=await fetch(url); if(!res.ok) throw new Error("Sheets API error");
  const json=await res.json();
  const rows=json.values||[]; if(!rows.length) return [];
  const headers=rows[0].map(h=>(h||'').trim());
  return rows.slice(1).map(r=>Object.fromEntries(headers.map((h,i)=>[h,r[i]||""])));
}
function normalizeRow(row){
  return {
    name:row["Name"]||"Untitled",
    address:row["Address"]||"",
    lat:parseFloat(row["Latitude"])||null,
    lng:parseFloat(row["Longitude"])||null,
    notes:row["Notes"]||"",
    group:row["Group"]||"",
    iconUrl:row["Icon URL"]||""
  };
}
function renderList(places){
  const list=document.getElementById("list"); list.innerHTML="";
  for(const p of places){
    const item=document.createElement("div"); item.className="card";
    const iconSrc=resolveIconSrc(p);
    const iconEl=iconSrc?`<img class="pin-img" src="${iconSrc}" alt=""/>`:"";
    item.innerHTML=`${iconEl}<div><h4>${p.name}</h4><div>${p.group||""}</div></div>`;
    item.addEventListener("click",()=>{
      const m=markers.find(mk=>mk.__data===p);
      if(m){ map.panTo(m.getPosition()); google.maps.event.trigger(m,"click"); }
    });
    list.appendChild(item);
  }
}
async function initApp(){
  const rows=await fetchSheetRows();
  allPlaces=rows.map(normalizeRow).filter(p=>p.lat&&p.lng);
  map=new google.maps.Map(document.getElementById("map"),{center:CONFIG.MAP.center,zoom:CONFIG.MAP.zoom});
  infoWindow=new google.maps.InfoWindow();
  markers=allPlaces.map(p=>{
    const marker=new google.maps.Marker({position:{lat:p.lat,lng:p.lng},map,title:p.name,icon:buildIcon(p)});
    marker.__data=p;
    marker.addListener("click",()=>{infoWindow.setContent(markerHtml(p));infoWindow.open({anchor:marker,map});});
    return marker;
  });
  renderList(allPlaces);
}
window.__initMap=()=>initApp();
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAYvECoY90cl8YQwhKiBwEBKqW_zrK1AQY&callback=__initMap"></script>
</body>
</html>
